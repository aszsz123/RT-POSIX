## This is a project made within Seoul National University of Science and Technology
## Embedded Systems Laboratory 2018 - Raimarius Tolentino Delgado

#######################################################################################################
CUR_DIR = .
TOP_DIR=..

INC_POSIX = $(TOP_DIR)/include
LIB_POSIX = $(TOP_DIR)/lib
INC_DIRS = -I$(INC_POSIX) 

CFLAGS_OPTIONS = -Wall -O3 -mtune=native -flto
CFLAGS   = $(CFLAGS_OPTIONS) $(INC_DIRS)

LIB_EMBD_FULL = -L$(LIB_POSIX) -lrtposix
LDFLAGS	 += $(LIB_EMBD_FULL) -lm -lrt -lpthread
EXEC	+= task
START	= start

# CC = gcc
CC = gcc
LD = $(CROSS_COMPILE)ld
AS = $(CROSS_COMPILE)as

CHMOD	= /bin/chmod
MKDIR	= /bin/mkdir
ECHO	= echo
RM	= /bin/rm
#######################################################################################################
SOURCES = $(addsuffix .cpp, $(notdir $(EXEC)))
OBJECTS = $(addprefix $(CUR_DIR)/, $(notdir $(patsubst %.c, %.o, $(patsubst %.cpp, %.o, $(SOURCES)))))
vpath %.cpp $(CUR_DIR)/ 
#######################################################################################################
# SOURCES_C = $(addsuffix .c, $(notdir $(EXEC)))
# OBJECTS_C = $(addprefix $(CUR_DIR)/, $(notdir $(patsubst %.c, %.o, $(patsubst %.cpp, %.o, $(SOURCES_C)))))
# vpath %.c  $(CUR_DIR)/ 
#######################################################################################################

all: executables $(START)
	@$(ECHO) BUILD DONE.
	@$(CHMOD) +x $(START).sh

$(START): 
	@printf "#!/bin/bash \n" > $(START).sh
	@printf "## This is a project made within Seoul National University of Science and Technology \n" >> $(START).sh
	@printf "## Embedded Systems Laboratory 2018 - Raimarius Tolentino Delgado \n\n" >> $(START).sh
	@printf "## Start-up for dynamically linked executable file \n\n" >> $(START).sh
ifeq ($(RT_DOMAIN),xenomai)
	@printf "export LD_LIBRARY_PATH=$$LD_LIBRARY_PATH:$(XENOMAI_PATH)/lib:$(LIB_AIDE) \n" >> $(START).sh
else
	@printf "export LD_LIBRARY_PATH=$$LD_LIBRARY_PATH:$(LIB_POSIX) \n" >> $(START).sh
endif
	@printf "cur_dir=.\n\n" >> $(START).sh
	@printf "if [[ -x \$$1 ]]\n" >> $(START).sh
	@printf "then\n\t \$${cur_dir}/\$$1 \$$2 \$$3\n" >> $(START).sh
	@printf "else\n\t echo run with executable file\n" >> $(START).sh
	@printf "fi\n" >> $(START).sh


executables: $(EXEC)

$(EXEC): $(OBJECTS)
	$(CC) $(CFLAGS) -o $@.app $< $(LDFLAGS)

objects: $(OBJECTS)
$(CUR_DIR)/%.o : %.cpp
	$(CC) -MD $(CFLAGS) -c -o $@ $<
# $(CUR_DIR)/%.o : %.c
# 	$(CC) -MD $(CFLAGS) -c -o $@ $<

testing:
	@echo $(CUR_DIR)/
	@echo $(EXEC)
	@echo $(SOURCES)
	@echo $(OBJECTS)


clean:
	$(RM) -rf \
		$(EXEC) \
		*.o *.d *.app \
		$(START)*
re:
	make clean
	make 

.PHONY: all clean 
#######################################################################################################
# Include header file dependencies generated by -MD option:
-include $(CUR_DIR)/*.d


